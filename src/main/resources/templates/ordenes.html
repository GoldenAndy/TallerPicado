<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Órdenes de Trabajo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/estilos.css}">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex: 1;
        }
        .autocomplete-results {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            z-index: 1000;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #f1f1f1;
        }
        
        
 :root{
    --page-bg:#0d1724; --brand-1:#27e0a3; --brand-2:#00a2ff; --brand-3:#ff3e7f;
    --card-bg:rgba(255,255,255,0.04); --card-brd:rgba(255,255,255,0.12);
    --text-1:#eaf2ff; --text-2:#a9b6cd; --glow:0 0 24px rgba(39,224,163,.35);
  }

  /* Lienzo y contenedor */
  body{ background: var(--page-bg) !important; color: var(--text-1); }
  main.container{
    background: var(--card-bg) !important;
    border:1px solid var(--card-brd); border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.25);
  }

  /* Título + botón principal */
  main .d-flex h3{
    color:var(--text-1); font-weight:900; letter-spacing:.2px; margin:0;
    text-shadow:0 8px 26px rgba(0,162,255,.25), 0 2px 0 rgba(0,0,0,.35);
  }
  .btn-success{
    background: linear-gradient(90deg, var(--brand-1), var(--brand-2)) !important;
    border:none; color:#07121d !important; font-weight:800;
    box-shadow:0 10px 28px rgba(0,162,255,.28), inset 0 0 0 1px rgba(255,255,255,.15);
  }
  .btn-success:hover{ filter:brightness(1.05); transform: translateY(-1px); }

  /* Alertas legibles */
  .alert-success{ background:rgba(39,224,163,.12); border:1px solid rgba(39,224,163,.35); color:#d9fff1; }
  .alert-danger{  background:rgba(255,77,109,.12); border:1px solid rgba(255,77,109,.35);  color:#ffd7de; }
  .alert-warning{ background:rgba(255,193,7,.14);  border:1px solid rgba(255,193,7,.38);   color:#fff3cd; }

  /* Filtros */
  .form-control, .form-select{
    background: rgba(255,255,255,.05); border:1px solid var(--card-brd);
    color: var(--text-1); color-scheme: dark;
  }
  .form-control::placeholder{ color: var(--text-2); opacity:.85; }
  .form-control:focus, .form-select:focus{
    background: rgba(255,255,255,.06);
    border-color: rgba(0,162,255,.45);
    box-shadow: 0 0 0 .2rem rgba(0,162,255,.15);
    color: var(--text-1);
  }
  .form-select option{
    background: #0f1626; color: var(--text-1);
  }
  .btn-primary{
    background: linear-gradient(90deg, var(--brand-2), var(--brand-1)) !important;
    border:none; color:#07121d !important; font-weight:800;
    box-shadow:0 10px 24px rgba(39,224,163,.25);
  }

  /* Autocomplete (cliente/empleado) */
  .autocomplete-results{
    position:absolute; inset:auto 0 0 0; translate:0 8px;
    background: rgba(13,23,36,.98); border:1px solid var(--card-brd);
    color: var(--text-1); border-radius:12px; max-height:220px; overflow:auto;
    box-shadow: 0 18px 50px rgba(0,0,0,.35); z-index:1000;
  }
  .autocomplete-item{ padding:.55rem .8rem; cursor:pointer; }
  .autocomplete-item:hover{
    background: linear-gradient(90deg, rgba(39,224,163,.16), rgba(0,162,255,.16));
  }

  /* Tabla (tema oscuro + hover con esencia) */
  .table-responsive{ border-radius:16px; overflow:hidden; background:transparent; }

  /* Fallback: estiliza cualquier tabla dentro del main */
  main.container .table{
    margin-bottom:0; color: var(--text-1);
    --bs-table-bg: transparent;
    --bs-table-color: var(--text-1);
    --bs-table-border-color: var(--card-brd);
    --bs-table-striped-bg: rgba(255,255,255,.03);
    --bs-table-striped-color: var(--text-1);
  }
  main.container thead.table-success,
  main.container thead.table-success th{
    background: linear-gradient(90deg, rgba(39,224,163,.22), rgba(0,162,255,.22)) !important;
    color: var(--text-1) !important;
    border-bottom:1px solid var(--card-brd) !important;
  }
  main.container .table th, main.container .table td{
    border-color: var(--card-brd) !important; vertical-align: middle;
  }
  main.container .table-hover tbody tr{ transition: background .18s ease, box-shadow .18s ease; }
  main.container .table-hover tbody tr:hover,
  main.container .table-hover tbody tr:hover > *{
    background: linear-gradient(90deg, rgba(39,224,163,.16), rgba(0,162,255,.16)) !important;
    background-color: transparent !important; color: var(--text-1) !important;
  }
  main.container .table-hover tbody tr:hover{
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
  }

  /* Badges de estado (opcional: suaviza estilo) */
  .badge{ border-radius:999px; padding:.35rem .6rem; font-weight:800; letter-spacing:.2px; }

  /* Botones de acciones */
  .btn-warning.btn-sm{
    background: linear-gradient(135deg, #ffd24d, #ffb703) !important;
    border:none; color:#231a00 !important; font-weight:700;
  }
  .btn-danger.btn-sm{
    background: linear-gradient(135deg, #ff6680, #ff315a) !important;
    border:none; color:#2e000a !important; font-weight:700;
  }
  .btn-info.btn-sm{ color:#06141f !important; font-weight:700; }

  @media (max-width:576px){
    .col-md-3 .btn{ margin-top:.25rem; }
  }
    </style>
</head>
<body>
<!-- HEADER -->
<div th:replace="fragmentos :: header"></div>

<!-- MENSAJES -->
<div th:if="${ok}" class="alert alert-success alert-dismissible fade show" role="alert">
  <i class="bi bi-check-circle me-2"></i><span th:text="${ok}">Operación exitosa.</span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
  <i class="bi bi-x-circle me-2"></i><span th:text="${error}">Ocurrió un error.</span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>


<!-- AVISO DE CONFIRMACIÓN PARA BORRADO EN CASCADA -->
<div th:if="${requiereConfirmacion}" class="alert alert-warning d-flex align-items-center justify-content-between">
  <div>
    <i class="bi bi-exclamation-triangle me-2"></i>
    <span th:text="${msg}">La orden actual tiene producciones en curso, ¿desea borrar ambas?</span>
  </div>
  <form th:action="@{'/ordenes/eliminar/' + ${idPendiente}}" method="get" class="ms-3">
    <input type="hidden" name="confirmar" value="1"/>
    <button type="submit" class="btn btn-danger btn-sm">
      <i class="bi bi-trash me-1"></i> Borrar orden y producciones
    </button>
  </form>
</div>

<main class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-journal-text me-2"></i> Órdenes de Trabajo</h3>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregarOrden">
            <i class="bi bi-plus-circle me-1"></i> Nueva Orden
        </button>
    </div>
    
    <form class="row g-3 mb-3" th:action="@{/ordenes/filtros}" method="get">
        <div class="col-md-5">
            <input type="text" name="cliente" class="form-control" placeholder="Buscar por cliente..." th:value="${cliente}">
        </div>
        <div class="col-md-4">
            <select name="estado" class="form-select">
                <option value="">-- Estado --</option>
                <option th:each="e : ${estados}"
                        th:value="${e}"
                        th:text="${e}"
                        th:selected="${estado == e}">
                </option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" type="submit">
                <i class="bi bi-search"></i> Buscar
            </button>
        </div>
    </form>


    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-success text-center">
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Empleado</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody class="text-center">
            <tr th:if="${ordenes.size() == 0}">
                <td colspan="6" class="text-muted">No hay órdenes que coincidan con los filtros</td>
            </tr>
            <tr th:each="orden : ${ordenes}">
                <td th:text="${orden.id}">1</td>
                <td th:text="${#dates.format(orden.fecha, 'yyyy-MM-dd')}">2025-07-10</td>
                <td th:text="${orden.cliente.nombre}">Juan Pérez</td>
                <td th:text="${orden.empleado.nombre}">Andrés Ewe</td>
                <td>
                    <span th:class="'badge ' + ${orden.estado == 'ENTREGADA' ? 'bg-success' : (orden.estado == 'EN_PROCESO' ? 'bg-warning text-dark' : 'bg-secondary')}"
                          th:text="${orden.estado}">PENDIENTE</span>
                </td>
                <td>
                    <button class="btn btn-warning btn-sm me-1" data-bs-toggle="modal"
                            th:attr="data-bs-target='#modalEditarOrden' + ${orden.id}">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <a th:href="@{'/ordenes/eliminar/' + ${orden.id}}"
                       class="btn btn-danger btn-sm me-1"
                       onclick="return confirm('¿Eliminar esta orden?');">
                        <i class="bi bi-trash"></i>
                    </a>
                    <a th:href="@{'/produccion/orden/' + ${orden.id}}" class="btn btn-info btn-sm">
                        <i class="bi bi-hammer"></i> Ver Producción
                    </a>
                </td>
            </tr>
            </tbody>

        </table>
    </div>
</main>

<!-- MODAL: Agregar Orden -->
<div class="modal fade" id="modalAgregarOrden" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form class="modal-content" th:action="@{/ordenes/guardar}" method="post">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Registrar Nueva Orden</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
                <div class="col-md-6 position-relative">
                    <label for="clienteInput" class="form-label">Cliente</label>
                    <input type="text" class="form-control" id="clienteInput" name="clienteNombre" placeholder="Buscar cliente...">
                    <div id="clienteResultados" class="autocomplete-results"></div>
                </div>
                <div class="col-md-6 position-relative">
                    <label for="empleadoInput" class="form-label">Empleado</label>
                    <input type="text" class="form-control" id="empleadoInput" name="empleadoNombre" placeholder="Buscar empleado...">
                    <div id="empleadoResultados" class="autocomplete-results"></div>
                </div>
                <div class="col-md-6">
                    <label for="estado" class="form-label">Estado</label>
                    <select class="form-select" name="estado" id="estado" required>
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="EN_PROCESO">EN_PROCESO</option>
                        <option value="FINALIZADA">FINALIZADA</option>
                        <option value="ENTREGADA">ENTREGADA</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Guardar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </form>
    </div>
</div>


<!-- MODALES: Editar Orden -->
<div th:each="orden : ${ordenes}">
    <div class="modal fade" th:id="'modalEditarOrden' + ${orden.id}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <form class="modal-content" th:action="@{'/ordenes/actualizar/' + ${orden.id}}" method="post">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Orden</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Cliente</label>
                        <input type="text" class="form-control" th:value="${orden.cliente.nombre}" name="clienteNombre">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Empleado</label>
                        <input type="text" class="form-control" th:value="${orden.empleado.nombre}" name="empleadoNombre">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Estado</label>
                        <select class="form-select" name="estado" required>
                            <option th:each="estado : ${estados}"
                                    th:value="${estado}"
                                    th:text="${estado}"
                                    th:selected="${orden.estado == estado}">Estado</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning">Actualizar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- FOOTER -->
<div th:replace="fragmentos :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function configurarAutocomplete(inputId, resultadoId, endpoint) {
        const input = document.getElementById(inputId);
        const resultados = document.getElementById(resultadoId);

        input.addEventListener("input", function () {
            const query = input.value;
            if (query.length < 2) {
                resultados.innerHTML = "";
                return;
            }

            fetch(`/${endpoint}?q=` + query)
                .then(res => res.json())
                .then(data => {
                    resultados.innerHTML = "";
                    data.forEach(item => {
                        const div = document.createElement("div");
                        div.classList.add("autocomplete-item");
                        div.textContent = item.nombre;
                        div.addEventListener("click", () => {
                            input.value = item.nombre;
                            resultados.innerHTML = "";
                        });
                        resultados.appendChild(div);
                    });
                });
        });
    }

    configurarAutocomplete("clienteInput", "clienteResultados", "clientes/autocompletar");
    configurarAutocomplete("empleadoInput", "empleadoResultados", "empleados/autocompletar");


</script>
</body>
</html>
